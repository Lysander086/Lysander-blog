# Anchor シリーズ テストフレームワーク 統合仕様書

## 文書情報
- **作成日**: 2024-11-02
- **バージョン**: 1.0
- **対象プロジェクト**: Anchor Focus App + Anchor Landing Page
- **目的**: 収益アプリケーションの品質保証とテスト自動化の基盤構築

---

## 1. プロジェクト概要

### 1.1 対象リポジトリ
| プロジェクト                  | リポジトリパス                                            | 技術スタック              | テストフレームワーク  |
| ----------------------- | -------------------------------------------------- | ------------------- | ----------- |
| **Anchor Focus App**    | `anchor-series-k8s/anchor-app/af-fe`               | React Native / Expo | **Maestro** |
| **Anchor Landing Page** | `anchor-series-k8s/anchor-app/anchor-landing-page` | Next.js / React     | **Cypress** |
|                         |                                                    |                     |             |
|                         |                                                    |                     |             |

### 1.2 テスト戦略の全体像 
 
`Lysander-blog\2025\consutaiton_n_interview\diagrams\anchor-test-ecosystem.drawio`


---

## 2. テストフレームワーク詳細仕様

### 2.1 Anchor Focus App (React Native) - Maestro

#### 2.1.1 なぜ Maestro を選ぶのか

**選定理由:**

| 要因                 | Maestro     | Detox        | Appium |     |
| ------------------ | ----------- | ------------ | ------ | --- |
| **学習曲線**           | ⭐⭐⭐⭐⭐ 非常に簡単 | ⭐⭐⭐ 中程度      | ⭐⭐ 複雑  |     |
| **セットアップ時間**       | 5分以内        | 30-60分       | 60分以上  |     |
| **Flake耐性**        | ⭐⭐⭐⭐⭐ 組み込み  | ⭐⭐⭐ 要手動調整    | ⭐⭐ 低い  |     |
| **YAML宣言的構文**      | ✅ あり        | ❌ JavaScript | ❌ 複数言語 |     |
| **React Native対応** | ⭐⭐⭐⭐⭐ 最適化   | ⭐⭐⭐⭐ 良好      | ⭐⭐⭐ 標準 |     |
| **コスト**            | 無料          | 無料           | 無料     |     |
| **実績**             | Bluesky採用   | 広く使用         | 広く使用   |     |

**決定要因:**
- Bluesky Social が本番環境で採用している実績
- YAML ベースのシンプルな記法で、非エンジニアでも読みやすい
- React Native に最適化されたFlake-free設計
- 5分以内にテストを開始できる高速セットアップ

#### 2.1.2 実装仕様

**ディレクトリ構造:**

プロジェクトルート直下に以下の構造を配置する:
- E2Eテスト専用ディレクトリ(__e2e__)を作成し、その中にMaestroテストフローを配置
  - flowsサブディレクトリにYAML形式のテストフローファイルを格納(オンボーディング、フォーカスセッション、設定画面、分析画面)
  - helpersサブディレクトリにヘルパースクリプトを配置
- ユニット・統合テスト用ディレクトリ(__tests__)を作成
  - componentsサブディレクトリにコンポーネントテストを配置
  - hooksサブディレクトリにフックテストを配置
  - utilsサブディレクトリにユーティリティテストを配置
- モックデータ用ディレクトリ(__mocks__)を作成
- Jest設定ファイル(jest.config.js)をルートに配置
- Maestro設定ファイル(maestro.yaml)をルートに配置

**package.json スクリプト:**

以下のNPMスクリプトを定義する:
- test: Jestを強制終了モードとタイムアウト20秒で実行
- test:watch: Jest監視モードで実行
- test:ci: CI環境用にJestを実行(デフォルトレポーターとjest-junitレポーターを使用)
- test:coverage: カバレッジレポート付きでJestを実行
- e2e:install: Maestroの公式インストールスクリプトを実行
- e2e:run: __e2e__/flowsディレクトリ内の全Maestroテストを実行
- e2e:run:single: 単一のMaestroテストを実行
- e2e:studio: Maestro Studioを起動(対話的テスト作成ツール)
- e2e:record: Maestroテストの記録を開始

**依存関係:**

開発依存パッケージとして以下をインストールする:
- jest バージョン29.7.0以上: JavaScriptテストフレームワーク
- jest-expo バージョン54.0.13前後: Expo専用のJestプリセット
- @testing-library/react-native バージョン13.2.0以上: React Nativeコンポーネントテスト用ライブラリ
- @testing-library/jest-native バージョン5.4.3以上: React Native用のJestマッチャー
- @types/jest バージョン29.5.14以上: Jest用のTypeScript型定義
- babel-jest バージョン29.7.0以上: Babel変換を統合するJestプラグイン

**Maestro テスト例 - フォーカスセッション:**

フォーカスセッションのE2Eテストフローは以下のシナリオで構成する:
1. アプリケーション起動: 対象アプリ(com.anchor.focus)を起動
2. ログイン状態確認: ホーム画面が表示されることを確認
3. 新規セッション開始: 「新しいセッション」ボタンをタップし、タイマー設定画面が表示されることを確認
4. タイマー設定: 25分を選択し、開始ボタンをタップ
5. セッション実行確認: 「集中中」テキストと「25:00」タイマー表示を確認
6. 一時停止機能: 一時停止ボタンをタップし、「再開」ボタンが表示されることを確認
7. 再開機能: 再開ボタンをタップし、「集中中」状態に戻ることを確認
8. セッション終了: 終了ボタンをタップし、確認ダイアログで確定、完了メッセージ表示を確認
9. 統計表示: 統計画面へ遷移し、「今日の集中時間」が表示されることを確認

#### 2.1.3 CI/CD 統合

**GitHub Actions ワークフロー設計:**

モバイルアプリテスト用のGitHub Actionsワークフローを以下のように構成する:

**ワークフロートリガー:**
- mainまたはdevelopブランチへのpush時に実行
- af-feディレクトリ配下のファイル変更時のみ実行
- mainまたはdevelopブランチへのPull Request作成時に実行
- af-feディレクトリ配下のファイル変更があるPRのみ対象

**ユニットテストジョブ (unit-tests):**
- Ubuntu最新版の環境で実行
- 実行ステップ:
  1. リポジトリをチェックアウト
  2. Node.js 18をセットアップ
  3. af-feディレクトリで依存関係をインストール
  4. CI用テストスクリプトを実行
  5. カバレッジレポートをCodecovにアップロード

**E2Eテストジョブ (e2e-tests):**
- macOS最新版の環境で実行(iOSシミュレータ用)
- 実行ステップ:
  1. リポジトリをチェックアウト
  2. Node.js 18をセットアップ
  3. af-feディレクトリで依存関係をインストール
  4. Maestroの公式インストールスクリプトを実行
  5. Expoアプリをビルド(iOS Release構成)
  6. __e2e__/flowsディレクトリ内のMaestroテストを実行
  7. テスト結果を常にアーティファクトとしてアップロード

---

### 2.2 Anchor Landing Page (Next.js) - Cypress

#### 2.2.1 なぜ Cypress を選ぶのか

**選定理由:**

| 要因 | Cypress | Playwright | Selenium |
|-----|---------|------------|----------|
| **開発者体験** | ⭐⭐⭐⭐⭐ 最高 | ⭐⭐⭐⭐ 優秀 | ⭐⭐ 標準 |
| **デバッグ機能** | ⭐⭐⭐⭐⭐ タイムトラベル | ⭐⭐⭐⭐ トレース | ⭐⭐ 基本 |
| **Next.js対応** | ⭐⭐⭐⭐⭐ 公式サポート | ⭐⭐⭐⭐ 良好 | ⭐⭐⭐ 標準 |
| **ネットワークスタブ** | ⭐⭐⭐⭐⭐ 強力 | ⭐⭐⭐⭐ 良好 | ⭐⭐ 基本 |
| **GUIテストランナー** | ⭐⭐⭐⭐⭐ 最高 | ⭐⭐⭐ UI Mode | ❌ なし |
| **学習曲線** | ⭐⭐⭐⭐ 簡単 | ⭐⭐⭐ 中程度 | ⭐⭐ 複雑 |
| **コスト** | 無料(OSS) | 無料 | 無料 |

**決定要因:**
- Next.js との公式統合とベストプラクティス
- 優れたデバッグ体験(タイムトラベル、自動待機)
- Webアプリケーションのテストの業界標準
- ネットワークリクエストのモック・スタブが容易

#### 2.2.2 実装仕様

**ディレクトリ構造:**

プロジェクトルート直下に以下の構造を配置する:
- Cypress専用ディレクトリを作成
  - e2eサブディレクトリ内にTypeScriptテストファイルを配置(ホームページ、価格ページ、サインアップ、お問い合わせ各画面用)
  - fixturesサブディレクトリにJSON形式のテストデータファイルを配置(ユーザー情報、価格情報)
  - supportサブディレクトリにサポートファイルを配置
    - commands.tsファイルにカスタムコマンドを定義
    - e2e.tsファイルにグローバル設定を記述
  - screenshotsサブディレクトリ(テスト失敗時に自動生成)
- ユニット・コンポーネントテスト用ディレクトリ(__tests__)を作成
  - componentsサブディレクトリにコンポーネントテストを配置
  - pagesサブディレクトリにページテストを配置
  - utilsサブディレクトリにユーティリティテストを配置
- Cypress設定ファイル(cypress.config.ts)をルートに配置
- Jest設定ファイル(jest.config.js)をルートに配置
- Next.js設定ファイル(next.config.js)をルートに配置

**package.json スクリプト:**

以下のNPMスクリプトを定義する:

**Next.js基本スクリプト:**
- dev: 開発サーバーを起動
- build: 本番用にビルド
- start: 本番サーバーを起動

**Jestテストスクリプト:**
- test: Jestを実行
- test:watch: Jest監視モードで実行
- test:ci: CI環境用にカバレッジ付きでJestを実行

**Cypressテストスクリプト:**
- cypress: Cypress GUIテストランナーを起動
- cypress:headless: ヘッドレスモードでCypressを実行
- cypress:ci: 開発サーバー起動後にヘッドレスCypressを実行(サーバー待機機能付き)

**統合テストスクリプト:**
- test:e2e: 開発サーバー起動後にCypress GUIを起動
- test:all: CI用テストとCypressテストを順次実行

**依存関係:**

開発依存パッケージとして以下をインストールする:

**Cypress関連:**
- cypress バージョン13.6.0以上: E2Eテストフレームワーク
- start-server-and-test バージョン2.0.3以上: サーバー起動とテスト実行を統合するツール

**Jest関連:**
- jest バージョン29.7.0以上: JavaScriptテストフレームワーク
- jest-environment-jsdom バージョン29.7.0以上: ブラウザ環境をシミュレートするJest環境
- @testing-library/react バージョン14.1.2以上: Reactコンポーネントテスト用ライブラリ
- @testing-library/jest-dom バージョン6.1.5以上: DOM用のJestマッチャー

**TypeScript関連:**
- @types/jest バージョン29.5.14以上: Jest用のTypeScript型定義
- typescript バージョン5.3.3以上: TypeScriptコンパイラ

**cypress.config.ts:**

TypeScriptでCypress設定ファイルを作成し、以下の設定を行う:

**E2E設定:**
- ベースURL: http://localhost:3000 を指定
- ビューポートサイズ: 幅1280px、高さ720pxに設定
- ビデオ録画: 有効化
- 失敗時スクリーンショット: 有効化
- Nodeイベントリスナー: 必要に応じてイベントハンドラーを設定

**コンポーネントテスト設定:**
- 開発サーバー設定: Next.jsフレームワークとWebpackバンドラーを指定

**Cypress テスト例 - ホームページ:**

ホームページのCypressテストスイートは以下のテストケースで構成する:

**事前処理:**
- 各テストケース実行前にルートパス(/)にアクセス

**テストケース1: ページ読み込み確認**
- ページタイトルに「Anchor」が含まれることを確認
- h1要素が表示されることを確認

**テストケース2: ナビゲーションメニュー表示確認**
- nav要素が表示されることを確認
- nav要素内に「機能」「料金」「お問い合わせ」リンクが表示されることを確認

**テストケース3: CTAボタン遷移確認**
- 「無料で始める」ボタンをクリック
- URLに「/signup」が含まれることを確認

**テストケース4: レスポンシブデザイン確認**
- モバイルビュー(iPhone X): モバイルメニューボタンが表示されることを確認
- タブレットビュー(iPad 2): ナビゲーションが表示されることを確認
- デスクトップビュー(1920x1080): ナビゲーションが表示されることを確認

**テストケース5: フォーム送信確認**
- POSTリクエスト(/api/contact)をモック化し、成功レスポンスを返す
- contact-formフォーム内の各フィールドに入力(名前、メール、メッセージ)
- 送信ボタンをクリック
- モックされたリクエストの完了を待機
- 「送信完了」メッセージが表示されることを確認

**カスタムコマンド例:**

Cypressカスタムコマンドを定義し、テストコードの再利用性を向上させる:

**TypeScript型定義:**
- Cypress名前空間内にChainableインターフェースを拡張
- login(email, password)メソッドを定義
- logout()メソッドを定義

**loginカスタムコマンド:**
- 目的: ユーザーログイン処理を再利用可能にする
- 引数: emailとpasswordを受け取る
- 処理内容:
  1. セッション管理機能を使用してログイン状態を保持
  2. ログインページ(/login)にアクセス
  3. emailフィールドに引数のemailを入力
  4. passwordフィールドに引数のpasswordを入力
  5. 送信ボタンをクリック
  6. URLが/loginから遷移したことを確認

**logoutカスタムコマンド:**
- 目的: ログアウト処理を再利用可能にする
- 処理内容:
  1. ユーザーメニューをクリック
  2. ログアウトリンクをクリック
  3. ルートページ(/)に遷移したことを確認

#### 2.2.3 CI/CD 統合

**GitHub Actions ワークフロー設計:**

ランディングページテスト用のGitHub Actionsワークフローを以下のように構成する:

**ワークフロートリガー:**
- mainまたはdevelopブランチへのpush時に実行
- anchor-landing-pageディレクトリ配下のファイル変更時のみ実行
- mainまたはdevelopブランチへのPull Request作成時に実行
- anchor-landing-pageディレクトリ配下のファイル変更があるPRのみ対象

**ユニットテストジョブ (unit-tests):**
- Ubuntu最新版の環境で実行
- 実行ステップ:
  1. リポジトリをチェックアウト
  2. Node.js 18をセットアップ
  3. anchor-landing-pageディレクトリで依存関係をクリーンインストール
  4. CI用テストスクリプトを実行
  5. カバレッジレポートをCodecovにアップロード

**Cypressテストジョブ (cypress-tests):**
- Ubuntu最新版の環境で実行
- 実行ステップ:
  1. リポジトリをチェックアウト
  2. Node.js 18をセットアップ
  3. Cypress公式GitHub Actionを使用してテスト実行
     - 作業ディレクトリ: anchor-landing-page
     - ビルドコマンド: npm run build
     - 起動コマンド: npm start
     - サーバー待機URL: http://localhost:3000
     - ブラウザ: Chrome
  4. テスト失敗時にスクリーンショットをアーティファクトとしてアップロード
  5. 常にビデオをアーティファクトとしてアップロード

---

## 3. Playwright MCP サーバーの役割と統合

### 3.1 Playwright MCP とは

**Model Context Protocol (MCP)** は、AIツール(Claude等)がローカル開発環境と連携するためのプロトコルです。Playwright MCP サーバーは、このプロトコルを使用してAIがブラウザ操作とテスト生成を支援します。

### 3.2 統合テストにおける位置づけ

**Playwright MCP の統合アーキテクチャ:**

システムは以下の階層構造で構成される:

1. **トップレイヤー: 開発者/QAエンジニア**
   - テスト計画と実行指示を行う人間

2. **ミドルレイヤー: VS Code (Copilot plugin)**
   - AI支援開発環境
   - 開発者の指示を受け取りMCPサーバーに伝達

3. **MCPサーバーレイヤー: Playwright MCP サーバー**
   - ブラウザ操作を実行
   - スクリーンショットを取得
   - ページ構造を解析
   - テストコードを実行

4. **テストフレームワークレイヤー:**
   - Cypress: ランディングページのE2Eテスト用
   - Maestro: モバイルアプリのE2Eテスト用

### 3.3 具体的な活用シナリオ

#### シナリオ1: ランディングページの探索とテスト生成

**人間の指示例:**
「http://localhost:3000 のランディングページを探索して、主要なユーザーフローをテストするCypressテストを生成してください」

**Playwright MCP の実行プロセス:**
1. 指定されたURLのページにアクセスしてDOM構造を解析
2. インタラクティブ要素(ボタン、フォーム、リンク等)を特定
3. ナビゲーションフローを追跡・記録
4. 主要画面のスクリーンショットを取得

**AIによる成果物生成:**
- Cypressテストコード(自動生成)
- テストシナリオのドキュメント
- 潜在的な問題点やアクセシビリティ課題の指摘

#### シナリオ2: バグの再現と修正支援

**人間の指示例:**
「お問い合わせフォームで送信エラーが発生します。この問題を再現して、原因を特定してください」

**Playwright MCP の実行プロセス:**
1. お問い合わせフォームにアクセス
2. 各入力フィールドにテストデータを入力
3. 送信ボタンをクリックして動作を確認
4. ネットワークリクエストを監視・記録
5. エラーメッセージやコンソール出力をキャプチャ

**AIによる分析結果:**
- エラーの根本原因の特定
- 具体的な修正案の提示
- 回帰防止用テストコードの生成

#### シナリオ3: レスポンシブデザインのテスト

**人間の指示例:**
「ランディングページが各デバイスサイズで正しく表示されるかテストしてください」

**Playwright MCP の実行プロセス:**
1. 複数のビューポートサイズ(モバイル、タブレット、デスクトップ)でページを表示
2. 各デバイスサイズでスクリーンショットを取得
3. レイアウトの崩れや要素の重なりを自動検出

**AIによる成果物生成:**
- デバイス別のビジュアルリグレッションテストコード
- レスポンシブデザインの問題点を記載したレポート

### 3.4 セットアップと設定

#### 3.4.1 インストール

**Landing Page プロジェクト向けセットアップ手順:**

1. **作業ディレクトリへ移動:**
   - anchor-landing-pageディレクトリに移動

2. **Playwright と MCP サーバーのインストール:**
   - @playwright/testパッケージを開発依存パッケージとしてインストール
   - Playwrightブラウザバイナリをインストール

3. **MCP 設定ファイルの作成:**
   - .vscodeディレクトリ内にmcp.jsonファイルを作成
   - JSON形式で以下を設定:
     - サーバー名: "playwright"
     - コマンド: "npx"
     - 引数: ["@playwright/mcp@latest"]

#### 3.4.2 使用方法

**1. エディタでMCPサーバーを起動:**
- VSCode を再起動してMCP設定を読み込む
- ステータスバーでMCPサーバーの起動状態を確認

**2. AIに指示を出す (指示例):**
「ホームページ (http://localhost:3000) にアクセスして、以下のテストを生成してください:
1. ページ読み込みの検証
2. ナビゲーションの動作確認
3. CTAボタンのクリックテスト」

**3. 生成されたテストを実行:**
- Cypressテストとして保存した場合:
  - cypress runコマンドで特定のspecファイルを実行
- Playwrightテストとして保存した場合:
  - playwright testコマンドでテストを実行

### 3.5 Playwright MCP と Cypress/Maestro の使い分け

| 用途 | Playwright MCP | Cypress | Maestro |
|------|----------------|---------|---------|
| **テスト生成** | ⭐⭐⭐⭐⭐ AI支援 | 手動作成 | 手動作成 |
| **探索・デバッグ** | ⭐⭐⭐⭐⭐ 最適 | GUI Runner | Studio |
| **Web E2E** | ⭐⭐⭐⭐ 可能 | ⭐⭐⭐⭐⭐ 最適 | ❌ 非対応 |
| **Mobile E2E** | ❌ 非対応 | ❌ 非対応 | ⭐⭐⭐⭐⭐ 最適 |
| **CI/CD実行** | ⭐⭐⭐ 可能 | ⭐⭐⭐⭐⭐ 最適 | ⭐⭐⭐⭐⭐ 最適 |
| **学習コスト** | ⭐⭐⭐⭐ AI支援 | ⭐⭐⭐⭐ 簡単 | ⭐⭐⭐⭐⭐ 非常に簡単 |

**推奨使用パターン:**
1. **Playwright MCP**: テスト作成の初期段階、複雑なページの探索、デバッグ支援
2. **Cypress**: Landing Pageの本番E2Eテスト、CI/CD統合
3. **Maestro**: Mobile Appの本番E2Eテスト、CI/CD統合

---

## 4. 実装ロードマップ

### フェーズ1: 基盤構築 (1週間)

**Week 1:**
- [x] テスト戦略の策定
- [ ] Jest環境のセットアップ(両プロジェクト)
- [ ] 基本的なユニットテストの作成
- [ ] GitHub Actionsの基本設定

**成果物:**
- Jest設定ファイル
- サンプルユニットテスト
- CI/CD パイプライン(ユニットテストのみ)

### フェーズ2: E2Eテスト導入 (2週間)

**Week 2:**
- [ ] Cypress インストールと設定 (Landing Page)
- [ ] Maestro インストールと設定 (Mobile App)
- [ ] 主要ユーザーフローの特定
- [ ] E2Eテスト作成開始

**Week 3:**
- [ ] E2Eテストの拡充
- [ ] CI/CD統合
- [ ] テスト実行の自動化

**成果物:**
- Cypress/Maestro設定ファイル
- 主要フローのE2Eテスト
- 自動化されたCI/CDパイプライン

### フェーズ3: AI支援テスト (1週間)

**Week 4:**
- [ ] Playwright MCP サーバーのセットアップ
- [ ] AIによるテスト生成の実験
- [ ] ベストプラクティスの確立
- [ ] チームへの知識共有

**成果物:**
- MCP設定ドキュメント
- AI生成テストの例
- 使用ガイドライン

### フェーズ4: 最適化と拡張 (継続的)

**Ongoing:**
- [ ] テストカバレッジの向上
- [ ] パフォーマンステストの追加
- [ ] ビジュアルリグレッションテスト
- [ ] アクセシビリティテスト
- [ ] テストメンテナンスの効率化

---

## 5. 品質メトリクス

### 5.1 測定指標

| メトリクス | 目標値 | 測定方法 |
|-----------|-------|----------|
| **ユニットテストカバレッジ** | > 80% | Jest coverage |
| **E2Eテスト成功率** | > 95% | CI/CD結果 |
| **テスト実行時間** | < 10分 | CI/CD時間 |
| **バグ検出率** | > 90% | リリース前検出数 |
| **Flake率** | < 5% | 再実行成功率 |

### 5.2 レポーティング

**自動生成レポート:**
- ユニットテストカバレッジ (Codecov)
- E2Eテスト結果 (Cypress Dashboard / Maestro Cloud)
- ビジュアルリグレッション (Percy / Chromatic)

**定期レビュー:**
- 週次: テスト失敗の分析
- 月次: カバレッジとメトリクスのレビュー
- 四半期: テスト戦略の見直し

---

## 6. チェックリスト

### 6.1 Anchor Focus App (React Native + Maestro)

#### 環境セットアップ
- [ ] Node.js 18+ インストール確認
- [ ] Expo CLI インストール
- [ ] Jest セットアップ完了
- [ ] Maestro インストール完了
- [ ] iOS/Android シミュレータ/エミュレータ設定

#### テスト作成
- [ ] ユニットテスト: コンポーネント (最低5個)
- [ ] ユニットテスト: Hooks (最低3個)
- [ ] ユニットテスト: Utils (最低3個)
- [ ] E2E: オンボーディングフロー
- [ ] E2E: フォーカスセッション開始/終了
- [ ] E2E: 設定画面の操作
- [ ] E2E: 分析画面の表示

#### CI/CD
- [ ] GitHub Actions 設定完了
- [ ] ユニットテスト自動実行
- [ ] E2Eテスト自動実行 (iOS)
- [ ] E2Eテスト自動実行 (Android)
- [ ] テスト結果レポート自動生成
- [ ] カバレッジレポート自動アップロード

### 6.2 Anchor Landing Page (Next.js + Cypress)

#### 環境セットアップ
- [ ] Node.js 18+ インストール確認
- [ ] Next.js プロジェクト設定確認
- [ ] Jest + React Testing Library セットアップ
- [ ] Cypress インストール完了
- [ ] Playwright MCP サーバー設定完了

#### テスト作成
- [ ] ユニットテスト: コンポーネント (最低10個)
- [ ] ユニットテスト: Pages (全ページ)
- [ ] ユニットテスト: Utils (最低5個)
- [ ] E2E: ホームページナビゲーション
- [ ] E2E: 料金ページの表示
- [ ] E2E: サインアップフロー
- [ ] E2E: お問い合わせフォーム送信
- [ ] E2E: レスポンシブデザイン (3サイズ)

#### CI/CD
- [ ] GitHub Actions 設定完了
- [ ] ユニットテスト自動実行
- [ ] Cypressテスト自動実行
- [ ] テスト結果レポート自動生成
- [ ] カバレッジレポート自動アップロード
- [ ] スクリーンショット/ビデオ自動保存

### 6.3 Playwright MCP 統合

#### セットアップ
- [ ] Playwright インストール (Landing Page)
- [ ] MCP 設定ファイル作成
- [ ] VSCode 再起動とサーバー起動確認
- [ ] AI Assistant との接続確認

#### 活用
- [ ] AIによるページ探索の実施
- [ ] AIによるテスト生成の実験
- [ ] 生成テストの検証と改善
- [ ] チーム内での使用ガイドライン作成

---

## 7. ベストプラクティス

### 7.1 テスト作成

**DO:**
- ✅ テストは独立して実行可能にする
- ✅ 明確なテスト名を使用する (日本語可)
- ✅ AAA パターン (Arrange, Act, Assert) を使う
- ✅ データはfixtures/mocksで管理
- ✅ テストの実行速度を意識する

**DON'T:**
- ❌ テスト間で状態を共有しない
- ❌ 複数のことを1つのテストで検証しない
- ❌ ハードコードされた待機時間を使わない
- ❌ 本番APIに直接アクセスしない
- ❌ テストコードを複雑にしすぎない

### 7.2 CI/CD

**DO:**
- ✅ PR作成時に自動テスト実行
- ✅ マージ前にすべてのテストをパス
- ✅ テスト失敗時にスクリーンショット保存
- ✅ カバレッジレポートを可視化
- ✅ Flakeテストは即座に修正

**DON'T:**
- ❌ テスト失敗を無視してマージしない
- ❌ CI/CDのタイムアウトを長くしすぎない
- ❌ すべてのE2Eテストを毎回実行しない(並列化を活用)

### 7.3 メンテナンス

**DO:**
- ✅ 定期的にテストを見直す
- ✅ 不要なテストは削除する
- ✅ テストコードもレビューする
- ✅ テストのドキュメントを更新
- ✅ テストの実行時間を監視

---

## 8. トラブルシューティング

### 8.1 よくある問題

#### Maestro テストが Flake する

**原因:**
- ネットワーク遅延によるタイミングのずれ
- アニメーション完了を待たずにアサーションを実行
- 要素の表示タイミングの問題

**解決策:**
- 明示的な待機を追加する方法:
  1. アニメーション終了を待機するコマンドを追加
  2. ミリ秒単位の固定待機時間を設定(例: 2000ミリ秒)
  3. 特定要素の表示を待機してからアサーションを実行

#### Cypress テストがタイムアウトする

**原因:**
- ネットワークリクエストのレスポンスが遅い
- ページの読み込みに時間がかかる
- CSSセレクタが要素を見つけられない

**解決策:**
- タイムアウト調整: 要素取得時にtimeoutオプションを指定(例: 10000ミリ秒)
- ネットワークモック: APIリクエストをインターセプトしてfixtureデータを返す
- セレクタ最適化: data-testid属性を使用した具体的なセレクタを使用(汎用的なセレクタより高速)

#### CI/CD でのみテストが失敗

**原因:**
- CI環境で必要な環境変数が未設定
- ローカルとCI環境のタイムゾーンの違い
- 並列実行時のリソース競合

**解決策:**
- GitHub Actions環境変数の設定:
  1. タイムゾーンを明示的に設定(例: Asia/Tokyo)
  2. NODE_ENVをtestに設定
  3. 機密情報はGitHub Secretsを使用して設定

---

## 9. 参考リソース

### 9.1 公式ドキュメント
- [Maestro Documentation](https://maestro.mobile.dev/)
- [Cypress Documentation](https://docs.cypress.io/)
- [Jest Documentation](https://jestjs.io/)
- [Playwright MCP](https://github.com/tmeasday/playwright-mcp)
- [React Native Testing Library](https://testing-library.com/docs/react-native-testing-library/intro/)

### 9.2 学習リソース
- [Cypress in 100 Seconds](https://www.youtube.com/watch?v=BQqzfHQkREo)
- [Maestro を使用した自動 UI テスト](https://www.youtube.com/watch?v=...)
- [Bluesky Testing Strategy Research](bluesky-testing-research.md)

### 9.3 内部ドキュメント
- [Playwright MCP Setup Steps](./resources/playwright-mcp-setup-steps.md)
- [Task Breakdown](./task-breakdown.md)
- [Resources Main](./resources/main.md)
- [Draw.io ツール比較表](./drawio-tools-comparison.md)

### 9.4 図表・ダイアグラム
- [タイムラインフローチャート](./diagrams/timeline-flowchart.drawio) - 45分間タスク実行計画の可視化
- [Anchor テストエコシステム](./diagrams/anchor-test-ecosystem.drawio) - テストツール全体のアーキテクチャ図

#### タイムラインフローチャート
![[diagrams/timeline-flowchart.drawio]]

#### Anchor テストエコシステム
![[diagrams/anchor-test-ecosystem.drawio]]

---

## 10. まとめ

この仕様書は、Anchor シリーズアプリケーション(React Native モバイルアプリと Next.js ランディングページ)のテスト戦略を包括的に定義しました。

**主要な決定事項:**
1. **Mobile App (af-fe)**: Maestro を採用 - Bluesky実績、シンプルなYAML、Flake-free
2. **Landing Page**: Cypress を採用 - Next.js公式サポート、優れたDX、業界標準
3. **AI支援**: Playwright MCP - テスト生成、探索、デバッグの効率化

**次のステップ:**
1. フェーズ1の環境セットアップを完了する
2. 基本的なユニットテストを作成する
3. CI/CDパイプラインを構築する
4. E2Eテストを段階的に導入する
5. Playwright MCPで効率化を図る

**期待される効果:**
- 🚀 開発速度の向上
- 🐛 バグの早期発見
- 🔒 リリース品質の保証
- 📊 可視化されたメトリクス
- 🤖 AI支援による効率化

---

**文書バージョン**: 1.0
**最終更新**: 2024-11-02
**次回レビュー**: 2024-12-02